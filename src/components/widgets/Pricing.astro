---
import { Icon } from 'astro-icon/components';
import Button from '~/components/ui/Button.astro';
import Headline from '~/components/ui/Headline.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import type { Pricing as Props } from '~/types';

const {
  title = '',
  subtitle = '',
  tagline = '',
  prices = [],

  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// Check if any price has yearly pricing
const hasYearly = prices.some((p) => p.priceYearly && p.periodYearly);
---

<WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-7xl mx-auto ${classes?.container ?? ''}`} bg={bg}>
  <Headline title={title} subtitle={subtitle} tagline={tagline} />

  {
    hasYearly && (
      <div class="flex justify-center mb-8 intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade">
        <div class="relative mx-auto flex items-center space-x-2 rounded-full border border-border p-1.5">
          <button
            type="button"
            class="rounded-full px-10 py-2 text-[16px] font-medium leading-tight bg-primary text-white"
            data-pricing-button="monthly"
          >
            Monthly
          </button>
          <button
            type="button"
            class="rounded-full px-10 py-2 text-[16px] font-medium leading-tight text-black hover:bg-primary/10"
            data-pricing-button="yearly"
          >
            Annual
          </button>
          <span class="absolute -top-[18px] right-5 rounded-[52px] py-[2px] px-2 border border-border bg-bg-secondary text-default font-semibold text-[12px] leading-tight">
            Save up to 40%
          </span>
        </div>
      </div>
    )
  }

  <div class="flex items-stretch justify-center">
    <div
      class={`grid grid-cols-3 gap-4 dark:text-white sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 ${classes?.prices ?? ''}`}
    >
      {
        prices.map(
          ({
            title,
            subtitle,
            price,
            priceYearly,
            period,
            periodYearly,
            items,
            callToAction,
            hasRibbon = false,
            ribbonTitle,
            chipBgClass,
            chipTextClass,
          }) => (
            <div class="col-span-3 mx-auto flex w-full sm:col-span-1 md:col-span-1 lg:col-span-1 xl:col-span-1 intersect-once motion-safe:md:intersect:animate-fade motion-safe:md:opacity-0 intersect-quarter">
              {price && period && (
                <div class="rounded-[16px] backdrop-blur border border-gray-200 dark:border-gray-700 bg-white dark:bg-bg-secondary px-6 py-8 flex w-full max-w-sm flex-col justify-between text-center relative">
                  {hasRibbon && ribbonTitle && (
                    <div class="absolute right-[-5px] 2xl:right-[-8px] rtl:right-auto rtl:left-[-8px] rtl:2xl:left-[-10px] top-[-5px] 2xl:top-[-10px] z-[1] h-[100px] w-[100px] overflow-hidden text-right">
                      <span class="absolute top-[19px] right-[-21px] rtl:right-auto rtl:left-[-21px] block w-full rotate-45 rtl:-rotate-45 bg-primary text-center text-[10px] font-bold uppercase leading-5 text-white shadow-[0_3px_10px_-5px_rgba(0,0,0,0.3)] before:absolute before:left-0 before:top-full before:z-[-1] before:border-[3px] before:border-r-transparent before:border-b-transparent before:border-l-primary before:border-t-primary before:content-[''] after:absolute after:right-0 after:top-full after:z-[-1] after:border-[3px] after:border-l-transparent after:border-b-transparent after:border-r-primary after:border-t-primary after:content-['']">
                        {ribbonTitle}
                      </span>
                    </div>
                  )}
                  <div class="px-2 py-0">
                    {title && (
                      <div
                        class={`absolute top-4 left-4 w-fit rounded-full px-3 py-1.5 text-sm font-semibold tracking-wide z-10 ${chipBgClass ?? 'bg-primary'} ${chipTextClass ?? 'text-white'}`}
                      >
                        {title}
                      </div>
                    )}
                    {subtitle && (
                      <p class={`font-light sm:text-lg text-gray-600 dark:text-slate-400 ${title ? 'pt-12' : ''}`}>
                        {subtitle}
                      </p>
                    )}
                    <div class="my-8">
                      <div class="flex items-center justify-center text-center mb-1">
                        <span class="text-5xl">$</span>
                        <span
                          class="text-6xl font-extrabold"
                          data-pricing-amount
                          data-monthly-price={price}
                          data-yearly-price={priceYearly || price}
                        >
                          {price}
                        </span>
                      </div>
                      <span
                        class="text-base leading-6 lowercase text-gray-600 dark:text-slate-400"
                        data-pricing-period-text
                        data-monthly-period={period}
                        data-yearly-period={periodYearly || period}
                      >
                        {period}
                      </span>
                    </div>
                    {items && (
                      <ul class="my-8 md:my-10 space-y-2 text-left">
                        {items.map(
                          ({ description, icon }) =>
                            description && (
                              <li class="mb-1.5 flex items-start space-x-3 leading-7">
                                <Icon name={icon ? icon : 'tabler:check'} class="w-5 h-5 font-bold mt-1 text-primary" />
                                <span>{description}</span>
                              </li>
                            )
                        )}
                      </ul>
                    )}
                  </div>
                  {callToAction && (
                    <div class={`flex justify-center`}>
                      {typeof callToAction === 'string' ? (
                        <Fragment set:html={callToAction} />
                      ) : (
                        callToAction &&
                        callToAction.href && <Button {...(hasRibbon ? { variant: 'primary' } : {})} {...callToAction} />
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
          )
        )
      }
    </div>
  </div>
</WidgetWrapper>

<style>
  [data-pricing-button].active {
    @apply bg-primary text-white;
  }
  [data-pricing-button]:not(.active) {
    @apply text-black;
  }
</style>

<script is:inline>
  function initPricingToggle() {
    const buttons = document.querySelectorAll('[data-pricing-button]');
    const priceElements = document.querySelectorAll('[data-pricing-amount]');
    const periodElements = document.querySelectorAll('[data-pricing-period-text]');

    let isYearly = false;

    function updatePricing() {
      priceElements.forEach((el) => {
        el.textContent = isYearly
          ? el.getAttribute('data-yearly-price') || el.getAttribute('data-monthly-price')
          : el.getAttribute('data-monthly-price');
      });
      periodElements.forEach((el) => {
        el.textContent = isYearly
          ? el.getAttribute('data-yearly-period') || el.getAttribute('data-monthly-period')
          : el.getAttribute('data-monthly-period');
      });
      buttons.forEach((btn) => {
        const isActive = btn.dataset.pricingButton === (isYearly ? 'yearly' : 'monthly');
        if (isActive) {
          btn.classList.add('active', 'bg-primary', 'text-white');
          btn.classList.remove('text-black', 'hover:bg-primary/10');
        } else {
          btn.classList.remove('active', 'bg-primary', 'text-white');
          btn.classList.add('text-black', 'hover:bg-primary/10');
        }
      });
    }

    buttons.forEach((btn) => {
      btn.addEventListener('click', () => {
        isYearly = btn.dataset.pricingButton === 'yearly';
        updatePricing();
      });
    });

    updatePricing();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPricingToggle);
  } else {
    initPricingToggle();
  }

  document.addEventListener('astro:after-swap', () => {
    requestAnimationFrame(() => setTimeout(initPricingToggle, 0));
  });
</script>
